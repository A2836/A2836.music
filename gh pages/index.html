<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>静态站点示例</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <header class="container site-header">
    <a class="brand" href="/">
      <img src="/assets/img/logo.png" alt="logo" onerror="this.style.display='none'">
      <div>
        <div class="site-title" id="site-title">Site</div>
        <div class="site-tag" id="site-tag">tagline</div>
      </div>
    </a>
    <nav class="nav" id="main-nav"></nav>
  </header>

  <main class="container">
    <section class="hero">
      <div class="hero-card">
        <h1 id="hero-title">欢迎</h1>
        <p id="hero-sub">子标题</p>
      </div>
      <aside id="player-area" class="hero-card">
        <div class="stack">
          <div class="muted">播放控制</div>
          <div class="player" id="player">
            <button id="play-btn">播放</button>
            <div class="progress"><i id="progress-bar"></i></div>
            <button class="secondary" id="mute-btn">静音</button>
          </div>
        </div>
      </aside>
    </section>

    <section>
      <h2>精选内容</h2>
      <div class="grid" id="grid"></div>
    </section>

    <footer class="site-footer center muted">
      <div id="footer-text">© Site</div>
    </footer>
  </main>

  <script>
  async function init(){
    try{
      const r = await fetch('./static-site-template.json');
      const cfg = await r.json();

      // Header
      document.getElementById('site-title').textContent = cfg.site.title || 'Site';
      document.getElementById('site-tag').textContent = cfg.site.tagline || '';

      // Nav
      const nav = document.getElementById('main-nav');
      nav.innerHTML = '';
      (cfg.navigation||[]).forEach(item=>{
        const a = document.createElement('a');
        a.href = item.url || '#';
        a.textContent = item.label || item.url;
        nav.appendChild(a);
      });

      // Hero
      const homePage = (cfg.pages || []).find(p=>p.id==='home') || (cfg.pages||[])[0] || {};
      const hero = (homePage.data && homePage.data.hero) || {};
      document.getElementById('hero-title').textContent = hero.title || cfg.site.title || '欢迎';
      document.getElementById('hero-sub').textContent = hero.subtitle || cfg.site.metadata && cfg.site.metadata.description || '';

      // Grid: show posts then albums
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      const collections = cfg.collections || {};
      const items = [];
      if(collections.posts && Array.isArray(collections.posts.items)){
        collections.posts.items.forEach(it=> items.push(Object.assign({__type:'post',__meta:collections.posts}, it)));
      }
      if(collections.albums && Array.isArray(collections.albums.items)){
        collections.albums.items.forEach(it=> items.push(Object.assign({__type:'album',__meta:collections.albums}, it)));
      }

      if(items.length===0){
        grid.innerHTML = '<div class="muted">当前没有内容，编辑 static-site-template.json 添加 items。</div>';
      }

      items.forEach(it=>{
        const card = document.createElement('article');
        card.className = 'card';
        const img = document.createElement('img');
        img.src = (it.cover||it.image||cfg.assets && cfg.assets.images && cfg.assets.images[0]) || '/assets/img/logo.png';
        img.alt = it.title || '';
        img.onerror = function(){ this.src='/assets/img/logo.png'; };
        card.appendChild(img);

        const body = document.createElement('div'); body.className='card-body';
        const title = document.createElement('h3'); title.className='card-title'; title.textContent = it.title || 'Untitled';
        const meta = document.createElement('div'); meta.className='card-meta'; meta.textContent = it.date ? it.date : (it.slug || it.__type);
        const excerpt = document.createElement('p'); excerpt.className='muted'; excerpt.textContent = it.excerpt || '';

        body.appendChild(title); body.appendChild(meta); body.appendChild(excerpt);

        // action (link)
        const link = document.createElement('a'); link.href = (it.__meta && it.__meta.permalink) ? it.__meta.permalink.replace('{slug}', it.slug || '') : (it.url || '#');
        link.textContent = '查看'; link.className='nav'; link.style.marginTop='8px';
        body.appendChild(link);

        card.appendChild(body);
        grid.appendChild(card);
      });

      // Footer
      document.getElementById('footer-text').textContent = (cfg.site.metadata && cfg.site.metadata.author) ? `© ${cfg.site.metadata.author}` : `© ${cfg.site.title || ''}`;

      // Simple player wiring (no source by default)
      const playBtn = document.getElementById('play-btn');
      const muteBtn = document.getElementById('mute-btn');
      const progressBar = document.getElementById('progress-bar');
      // create an Audio element
      const audio = new Audio();
      audio.preload = 'none';
      // if first album or post has audioFile, use it
      const firstAudio = items.find(i=>i.audio || i.audioFile || i.src);
      if(firstAudio){
        audio.src = firstAudio.audio || firstAudio.audioFile || firstAudio.src;
      }

      let playing = false;
      playBtn.addEventListener('click', ()=>{
        if(!audio.src){ alert('未找到音频源。请在 static-site-template.json 的 items 中添加 audio 或 audioFile 字段。'); return; }
        if(playing){ audio.pause(); } else { audio.play(); }
      });
      audio.addEventListener('play', ()=>{ playing=true; playBtn.textContent='暂停'; });
      audio.addEventListener('pause', ()=>{ playing=false; playBtn.textContent='播放'; });
      audio.addEventListener('timeupdate', ()=>{
        const pct = audio.duration ? (audio.currentTime / audio.duration * 100) : 0;
        progressBar.style.width = pct + '%';
      });
      muteBtn.addEventListener('click', ()=>{ audio.muted = !audio.muted; muteBtn.textContent = audio.muted ? '取消静音' : '静音'; });

    }catch(e){
      console.error(e);
      document.body.insertAdjacentHTML('afterbegin', '<div style="padding:12px;background:#fee;color:#600">加载 JSON 失败：'+(e.message||e)+'</div>');
    }
  }
  window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
